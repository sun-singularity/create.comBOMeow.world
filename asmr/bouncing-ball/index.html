<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bouncing Ball Simulation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.17.1/matter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <style>
      body {
        transition: background-color 0.5s ease;
        background-color: black;
      }
      canvas {
        background: transparent;
      }
    </style>
  </head>
  <body>
    <button id="start-button">Start Simulation</button>
    <script>
      // Function to initialize the simulation after user interaction
      function initSimulation() {
        // Module aliases
        const Engine = Matter.Engine,
          Render = Matter.Render,
          Runner = Matter.Runner,
          Bodies = Matter.Bodies,
          Composite = Matter.Composite,
          Events = Matter.Events;

        // Create an engine
        const engine = Engine.create();
        engine.world.gravity.y = 0.5; // Set gravity to half

        // Create a renderer
        const render = Render.create({
          element: document.body,
          engine: engine,
          options: {
            width: window.innerWidth,
            height: window.innerHeight,
            wireframes: false,
            background: "transparent",
          },
        });

        // Create ground with no friction and perfect restitution
        const ground = Bodies.rectangle(
          window.innerWidth / 2,
          window.innerHeight - 20,
          window.innerWidth,
          40,
          {
            isStatic: true,
            friction: 0,
            frictionStatic: 0,
            restitution: 1, // Ensure perfect elastic collision
          }
        );

        // Add ground to the world
        Composite.add(engine.world, [ground]);

        // Run the renderer
        Render.run(render);

        // Create runner
        const runner = Runner.create();
        Runner.run(runner, engine);

        // Updated notes sequence C4DEFGABC5
        const beats = [
          "3",
          "2",
          "1",

          "2",
          "3",
          "5",
          "5",
          "5",
          "6",
          "5",

          "6",
          "7",
          "1d",
          "1d",
          "1d",
          "1d",
          "1d",
          "7",
          "6",
          "5",
          "6",

          "6",
          "5",
          "5",
          "5",
          "3",

          "3",
          "4",
          "3",
          "2",
          "2",
          "3",
          "2",

          "3",
          "2",
          "2",
          "1",
          "1",
          "1",
          "1",
          "2",
          "1",
          "1",

          "5",
          "6",
          "7",
          "1d",
        ];
        let beatIndex = 0;

        // Create sound objects for each beat
        const soundMap = {
          1: new Howl({ src: ["ukulele_sounds/1.wav"] }),
          2: new Howl({ src: ["ukulele_sounds/2.wav"] }),
          3: new Howl({ src: ["ukulele_sounds/3.wav"] }),
          4: new Howl({ src: ["ukulele_sounds/4.wav"] }),
          5: new Howl({ src: ["ukulele_sounds/5.wav"] }),
          6: new Howl({ src: ["ukulele_sounds/6.wav"] }),
          7: new Howl({ src: ["ukulele_sounds/7.wav"] }),
          "1d": new Howl({ src: ["ukulele_sounds/1d.wav"] }),
        };

        // Play a sound
        function playSound(note) {
          if (soundMap[note]) {
            soundMap[note].play();
          }
        }

        // Change background color progressively
        function changeBackgroundColor() {
          const step = Math.floor((beatIndex / beats.length) * 255);
          document.body.style.backgroundColor = `rgb(${step}, ${step}, ${step})`;
        }

        // Detect collision with ground
        Events.on(engine, "collisionStart", (event) => {
          const pairs = event.pairs;
          pairs.forEach((pair) => {
            if (
              (pair.bodyA.label === "ball" && pair.bodyB === ground) ||
              (pair.bodyA === ground && pair.bodyB.label === "ball")
            ) {
              if (beatIndex < beats.length) {
                playSound(beats[beatIndex]);
                changeBackgroundColor();
                beatIndex++;
                if (beatIndex >= beats.length) {
                  beatIndex = 0; // Loop the song
                }
              }
            }
          });
        });

        // Function to spawn a new ball at a given position
        function spawnBall(x, y) {
          const ball = Bodies.circle(x, y, 40, {
            restitution: 1, // Ensure perfect elastic collision
            friction: 0,
            frictionStatic: 0,
            density: 0.001,
            label: "ball",
          });
          Composite.add(engine.world, [ball]);
        }

        // Add click event listener to spawn a ball at the click position
        document.addEventListener("click", (event) => {
          const x = event.clientX;
          const y = event.clientY;
          spawnBall(x, y);
        });
      }

      // Add event listener to the button to start the simulation
      document.getElementById("start-button").addEventListener("click", () => {
        initSimulation();
        document.getElementById("start-button").style.display = "none"; // Hide the button after starting the simulation
      });
    </script>
  </body>
</html>
